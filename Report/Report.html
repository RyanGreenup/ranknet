<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-02-21 Sun 14:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Implementing of RankNet</title>
<meta name="author" content="Ryan Greenup" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="./resources/style.css">
<script type="text/javascript" src="https://orgmode.org/org-info.js">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
// @license-end
</script>

<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "9");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "3");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
// @license-end
</script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Implementing of RankNet</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga8966c8">1. Introduction</a></li>
<li><a href="#org06e72e9">2. Motivation</a></li>
<li><a href="#org739be3e">3. Implementation</a>
<ul>
<li><a href="#orgf0c63a0">3.1. Neural Networks</a>
<ul>
<li><a href="#orgc0c3df8">3.1.1. The Ranknet Method</a>
<ul>
<li><a href="#org54fb6d8">3.1.1.1. Version Control</a></li>
<li><a href="#org9c66b33">3.1.1.2. Code listings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0fbd223">3.2. Creating Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cf9ab26">cf9ab26</span></span></a></li>
<li><a href="#creating-neural-network">3.3. Creating a Neural Network&#xa0;&#xa0;&#xa0;<span class="tag"><span class="7291112">7291112</span></span></a></li>
<li><a href="#org418c87f">3.4. Train the Model with Gradient Descent&#xa0;&#xa0;&#xa0;<span class="tag"><span class="7d46636">7d46636</span></span></a></li>
<li><a href="#org1a59c54">3.5. Implement Ranknet&#xa0;&#xa0;&#xa0;<span class="tag"><span class="f25f376">f25f376</span>&#xa0;<span class="05df04f">05df04f</span></span></a></li>
<li><a href="#org746caac">3.6. Implement sorting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="99b390a">99b390a</span>&#xa0;<span class="7d46636">7d46636</span></span></a></li>
<li><a href="#orgd4409c0">3.7. Moons</a></li>
<li><a href="#orga808003">3.8. Optimisers</a></li>
<li><a href="#org865c3e2">3.9. Batches</a></li>
<li><a href="#orgbe7cf0a">3.10. Wine</a></li>
<li><a href="#org64cf152">3.11. Rank Wiki Articles</a></li>
</ul>
</li>
<li><a href="#orgfcfd80e">4. Difficulties</a></li>
<li><a href="#org0b49592">5. Further Research</a>
<ul>
<li><a href="#orgb8813f5">5.1. Practical Improvements</a></li>
<li><a href="#org459e246">5.2. Evaluate performance improvements</a></li>
<li><a href="#machine-learning-models">5.3. Evaluate alternative machine learning models</a></li>
</ul>
</li>
<li><a href="#org3282a97">6. Conclusion</a></li>
<li><a href="#org8f982a8">7. Text and References</a></li>
<li><a href="#org89639a6">8. Fractals</a></li>
<li><a href="#org90e20f4">9. Appendix</a>
<ul>
<li><a href="#search-engines-list">9.1. Search Engines</a>
<ul>
<li><a href="#orgbe05cd2">9.1.1. Fuzzy String Match</a></li>
</ul>
</li>
<li><a href="#standard-import">9.2. Import Statements</a></li>
<li><a href="#export-data-function">9.3. Export Data Method</a></li>
<li><a href="#version-control-repo">9.4. Version Control Repository</a>
<ul>
<li><a href="#git-log">9.4.1. Version Control Log for Walkthrough</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
# #+TODO: TODO IN-PROGRESS WAITING DONE
</p>
<p>

</p>

<div id="outline-container-orga8966c8" class="outline-2">
<h2 id="orga8966c8"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Ranknet is an approach to <i>Machine-Learned Ranking (often refered to
as "<i>/Learning to Rank</i></i>" <a class='org-ref-reference' href="#liuLearningRankInformation2009">liuLearningRankInformation2009</a>) that
began development at Microsoft from 2004 onwards
<a class='org-ref-reference' href="#christopherburgesRankNetRankingRetrospective2015">christopherburgesRankNetRankingRetrospective2015</a>, although
previous work in this area had already been undertaken as early as
the 90s (see generally
<a class='org-ref-reference' href="#fuhrProbabilisticModelsInformation1992">fuhrProbabilisticModelsInformation1992</a>,<a class='org-ref-reference' href="#fuhrOptimumPolynomialRetrieval1989">fuhrOptimumPolynomialRetrieval1989</a>,<a class='org-ref-reference' href="#fuhrProbabilisticModelsInformation1992">fuhrProbabilisticModelsInformation1992</a>,<a class='org-ref-reference' href="#geyInferringProbabilityRelevance1994">geyInferringProbabilityRelevance1994</a>,<a class='org-ref-reference' href="#wongLinearStructureInformation1988">wongLinearStructureInformation1988</a>)
these earlier models didn't perform well compared to more modern
machine learning techniques
<a class='org-ref-reference' href="#manningIntroductionInformationRetrieval2008">manningIntroductionInformationRetrieval2008</a>.
</p>

<p>
Information retrieval is an area that demands effective ranking of
queries, although straight-forward tools such as <code>grep</code>, relational
databases (e.g. sqlite, MariaDB, PostgreSql) or NoSQL (e.g. CouchDB,
MongoDB) can be used to retrieve documents with matching characters
and words, these methods do not perform well in real word tasks
across large collections of documents because they do not provide
any logic to rank results (see generally
<a class='org-ref-reference' href="#viksinghComparisonOpenSource2009">viksinghComparisonOpenSource2009</a>).
</p>
</div>
</div>


<div id="outline-container-org06e72e9" class="outline-2">
<h2 id="org06e72e9"><span class="section-number-2">2</span> Motivation</h2>
<div class="outline-text-2" id="text-2">
<p>
Search Engines implement more sophisticated techniques to rank
results, one such example being TF-IDF weighting
<a class='org-ref-reference' href="#martyschochBleveSearchDocumentation">martyschochBleveSearchDocumentation</a> , well established
search engines such as <i>Apache Lucene</i>
<a class='org-ref-reference' href="#apachesoftwarefoundationLearningRankApache2017">apachesoftwarefoundationLearningRankApache2017</a> and <i>Xapian</i>
<a class='org-ref-reference' href="#jamesaylettGSoCProjectIdeasLearningtoRankStabilisationXapian2019">jamesaylettGSoCProjectIdeasLearningtoRankStabilisationXapian2019</a>,
however, 
are implementing Machine-Learned Ranking in order to improve results.
</p>

<p>
This paper hopes to serve as a general introduction to the implementation
of the Ranknet technique to facilitate developers of search engines in
more modern languages (i.e. <code>Go</code> and <code>Rust</code>) in implementing
it. This is important because these more modern languages are more
accessible <a class='org-ref-reference' href="#huntThesisSubmittedPartial">huntThesisSubmittedPartial</a>
and memory safe <a class='org-ref-reference' href="#perkelWhyScientistsAre2020">perkelWhyScientistsAre2020</a> than C/C++
respectfully, without significantly impeding performance; this will
encourage contributors from more diverse backgrounds and hence
improve the quality of profession-specific tooling.
</p>


<p>
For a non-comprehensive list of actively maintained search engines,
see &sect; <a href="#search-engines-list">9.1</a> of the appendix.
</p>
</div>
</div>

<div id="outline-container-org739be3e" class="outline-2">
<h2 id="org739be3e"><span class="section-number-2">3</span> Implementation</h2>
<div class="outline-text-2" id="text-3">
<p>
Neural Networks 
</p>

<p>
Ranking/ is the process of applying machine learning algorithms to
ranking problems, it .
</p>

<p>
This implementation will first apply the approach to a simple data
set so as to clearly demonstrate that the approach works, following
that the model will be extended to support wider and more complex
data types before finally being implemented on a corpus of documents.
</p>
</div>

<div id="outline-container-orgf0c63a0" class="outline-3">
<h3 id="orgf0c63a0"><span class="section-number-3">3.1</span> Neural Networks</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The Ranknet method is typically implemented using a Neural Networks
<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>,
although other machine learning techniques can also be used
<a class='org-ref-reference' href="#christopherburgesRankNetRankingRetrospective2015">christopherburgesRankNetRankingRetrospective2015</a>,
Neural Networks are essentially a collection of different
regression models and classifiers that are fed into one another to create a
non-linear classifier, a loss function is used to measure the
performance of the model with respect to the parameters
(e.g. RMSE <sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> or BCE <sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>) and the parameters are adjusted so
as to reduce this error by using the <i>Gradient Descent Technique</i>
(although there are other optimisation algorithms such as RMSProp
and AdaGrad <a class='org-ref-reference' href="#mukkamalaVariantsRMSPropAdagrad2017">mukkamalaVariantsRMSPropAdagrad2017</a> that can be
shown to perform better, see
<a class='org-ref-reference' href="#bushaevUnderstandingRMSpropFaster2018">bushaevUnderstandingRMSpropFaster2018</a>). The specifics of
Neural Networks are beyond the scope of this paper (see
<a class='org-ref-reference' href="#hmkcodeBackpropagationStepStep">hmkcodeBackpropagationStepStep</a> or more generally <a class='org-ref-reference' href="#pictonNeuralNetworks1994">pictonNeuralNetworks1994</a>).
</p>
</div>

<div id="outline-container-orgc0c3df8" class="outline-4">
<h4 id="orgc0c3df8"><span class="section-number-4">3.1.1</span> The Ranknet Method</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
The Ranknet method is concerned with a value \(p_{ij}\) that
measures the probability that an observation \(i\) is ranked higher
than an observation \(j\).
</p>

<p>
A Neural Network (\(n\)) is trained to return a value
\(s_k\) from a feature vector \(\mathbf{X}_k\):
</p>

<p>
 \[n(\mathbf{X}_i) = s_i \quad \exists k\]
So as to minimise the error of:
</p>




\begin{align} 
 p_{ij} &= \mathrm{sig}\left(\sigma, (s_i-s_j) \right) \quad \exists \sigma \in \mathbb{R} \\
 &\text{where:} \nonumber \\
 &\quad  \mathrm{sig}\left(\sigma, x\right) = \frac{1}{1+e^{\sigma \cdot x}} 
\end{align} 
</div>



<div id="outline-container-org54fb6d8" class="outline-5">
<h5 id="org54fb6d8"><span class="section-number-5">3.1.1.1</span> Version Control</h5>
<div class="outline-text-5" id="text-3-1-1-1">
<p>
The implementation in this paper corresponds to the <code>walkthrough</code> branch
of the <code>git</code> repository used in production of this work, id values
(e.g. <code>:08db5b0:</code>) will be appended to titles to denote specific
changes made in that section. See &sect; <a href="#version-control-repo">9.4</a> for
more specific guidance.
</p>
</div>
</div>

<div id="outline-container-org9c66b33" class="outline-5">
<h5 id="org9c66b33"><span class="section-number-5">3.1.1.2</span> Code listings</h5>
<div class="outline-text-5" id="text-3-1-1-2">
<p>
The code listings provided will use a standard set of import
statements (see &sect; <a href="#standard-import">9.2</a> ) and so they will be
omitted from the listings, for more comprehensive guidance on
implementing this code refer to the <a href="https://crmds.github.io/CRMDS-HDR-Training-2020/">documentation page</a><sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup> that
accompanies the <code>git</code> repo.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org0fbd223" class="outline-3">
<h3 id="org0fbd223"><span class="section-number-3">3.2</span> Creating Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cf9ab26">cf9ab26</span></span></h3>
<div class="outline-text-3" id="text-3-2">
<p>
The first step is to create a simple data set and design a neural
network that can classify that data set, the data set generated
should have two classes of data (this could be interpreted as
relevant and irrelevant documents given the features or principle
components of a data set), this can be implemented using sci kit
learn as shown below and visualized<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup> in figure <a href="#org81ca8d8">1</a>.<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>
</p>


<p>
In order to fit a Neural Network the <i>PyTorch</i> package can be used
<a class='org-ref-reference' href="#NEURIPS2019_9015">NEURIPS2019_9015</a>, this will allow the gradients of the neural
network to be calculated numerically without needing to solve for
the partial derivatives, hence the data will need to be in the
form of tensors.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">make_data</span>(create_plot=<span style="color: #8470ff; font-weight: bold;">False</span>, n=1000, dtype=torch.<span style="color: #b0c4de;">float</span>, dev=<span style="color: #ffc1c1;">"cpu"</span>, export=<span style="color: #ffc1c1;">""</span>):
    X, y = datasets.make_blobs(n, 2, 2, random_state=7)
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">X, y = datasets.make_moons(n_samples=n, noise=0.1, random_state=0) # Moons Data for later</span>

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Save the data somewhere if necessary</span>
    <span style="color: #00ffff;">if</span> export != <span style="color: #ffc1c1;">""</span>:
        export_data(X, y, export)

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Reshape the data to be consistent</span>
    y = np.reshape(y, (<span style="color: #b0c4de;">len</span>(y), 1))  <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Make y vertical n x 1 matrix.</span>

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">-- Split data into Training and Test Sets --------------------</span>
    data = train_test_split(X, y, test_size=0.4)

    <span style="color: #00ffff;">if</span>(create_plot):
        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create the Scatter Plot</span>
        plt.scatter(X[:, 0], X[:, 1], c=y)
        plt.title(<span style="color: #ffc1c1;">"Sample Data"</span>)
        plt.show()

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Make sure we're working with tensors not mere numpy arrays</span>
    torch_data = [<span style="color: #8470ff; font-weight: bold;">None</span>]*<span style="color: #b0c4de;">len</span>(data)
    <span style="color: #00ffff;">for</span> i <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(<span style="color: #b0c4de;">len</span>(data)):
        torch_data[<span style="color: #7fffd4;">i</span>] = torch.tensor(data[i], dtype=dtype, requires_grad=<span style="color: #8470ff; font-weight: bold;">False</span>)

    <span style="color: #00ffff;">return</span> torch_data

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Set Torch Parameters</span>
dtype = torch.<span style="color: #b0c4de;">float</span>
dev = test_cuda()

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Generate the Data</span>
X_train, X_test, y_train, y_test = make_data(
    n=<span style="color: #b0c4de;">int</span>(300/0.4), create_plot=<span style="color: #8470ff; font-weight: bold;">True</span>, dtype=dtype, dev=dev, export = <span style="color: #ffc1c1;">"/tmp/simData.csv"</span>)
</pre>
</div>



<div id="org81ca8d8" class="figure">
<p><img src="./media/SimulatedData.png" alt="SimulatedData.png" width="400px" />
</p>
<p><span class="figure-number">Figure 1: </span>Generated data, output classes denote document relevance and the axis features or principle components</p>
</div>
</div>
</div>

<div id="outline-container-creating-neural-network" class="outline-3">
<h3 id="creating-neural-network"><span class="section-number-3">3.3</span> Creating a Neural Network&#xa0;&#xa0;&#xa0;<span class="tag"><span class="7291112">7291112</span></span></h3>
<div class="outline-text-3" id="text-creating-neural-network">
<p>
A Neural Network model can be designed as a class, here a 2-layer
model using Sigmoid functions has been described, this design was
chosen for it's relative simplicity:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">class</span> <span style="color: #63b8ff;">three_layer_classification_network</span>(nn.Module):
    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">__init__</span>(<span style="color: #00ffff;">self</span>, input_size, hidden_size, output_size, dtype=torch.<span style="color: #b0c4de;">float</span>, dev=<span style="color: #ffc1c1;">"cpu"</span>):
        <span style="color: #b0c4de;">super</span>(three_layer_ranknet_network, <span style="color: #00ffff;">self</span>).__init__()
        <span style="color: #00ffff;">self</span>.wi = torch.randn(input_size, hidden_size,
                              dtype=dtype,
                              requires_grad=<span style="color: #8470ff; font-weight: bold;">True</span>,
                              device=dev)
        <span style="color: #00ffff;">self</span>.wo = torch.randn(hidden_size, output_size,
                              dtype=dtype,
                              requires_grad=<span style="color: #8470ff; font-weight: bold;">True</span>,
                              device=dev)

        <span style="color: #00ffff;">self</span>.bi = torch.randn(hidden_size,
                              dtype=dtype,
                              requires_grad=<span style="color: #8470ff; font-weight: bold;">True</span>,
                              device=dev)
        <span style="color: #00ffff;">self</span>.bo = torch.randn(output_size,
                              dtype=dtype,
                              requires_grad=<span style="color: #8470ff; font-weight: bold;">True</span>,
                              device=dev)

        <span style="color: #00ffff;">self</span>.&#963; = torch.randn(1, dtype=dtype, requires_grad=<span style="color: #8470ff; font-weight: bold;">True</span>, device=dev)

        <span style="color: #00ffff;">self</span>.losses = []       <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">List of running loss values</span>
        <span style="color: #00ffff;">self</span>.trainedQ = <span style="color: #8470ff; font-weight: bold;">False</span>  <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Has the model been trained yet?</span>

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">forward</span>(<span style="color: #00ffff;">self</span>, x):
        x = torch.matmul(x, <span style="color: #00ffff;">self</span>.wi).add(<span style="color: #00ffff;">self</span>.bi)
        x = torch.sigmoid(x)
        x = torch.matmul(x, <span style="color: #00ffff;">self</span>.wo).add(<span style="color: #00ffff;">self</span>.bo)
        x = torch.sigmoid(x)
        <span style="color: #00ffff;">return</span> x

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">loss_fn</span>(<span style="color: #00ffff;">self</span>, x, y):
        y_pred = <span style="color: #00ffff;">self</span>.forward(x)
        <span style="color: #00ffff;">return</span> torch.mean(torch.<span style="color: #b0c4de;">pow</span>((y-y_pred), 2))

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">misclassification_rate</span>(<span style="color: #00ffff;">self</span>, x, y):
        y_pred = (<span style="color: #00ffff;">self</span>.forward(x) &gt; 0.5)
        <span style="color: #00ffff;">return</span> np.average(y != y_pred)
</pre>
</div>

<p>
A model can then be instantiated, a <code>2-3-1</code>
model has, arbitrarily, been implemented in this case:<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Set Seeds</span>
torch.manual_seed(1)
np.random.seed(1)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Set Torch Parameters</span>
<span style="color: #7fffd4;">dtype</span> = torch.<span style="color: #b0c4de;">float</span>
<span style="color: #7fffd4;">dev</span> = test_cuda()

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Make the Data</span>
<span style="color: #7fffd4;">X_train</span>, <span style="color: #7fffd4;">X_test</span>, <span style="color: #7fffd4;">y_train</span>, <span style="color: #7fffd4;">y_test</span> = make_data(
    n=100, create_plot=<span style="color: #8470ff; font-weight: bold;">True</span>, dtype=dtype, dev=dev)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create a model object</span>
model = three_layer_classification_network(
    input_size=X_train.shape[1], hidden_size=2, output_size=1, dtype=dtype, dev=dev)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Send some data through the model</span>
<span style="color: #00ffff;">print</span>(<span style="color: #ffc1c1;">"\nThe Network input is:\n---\n"</span>)
<span style="color: #00ffff;">print</span>(X_train[7,:], <span style="color: #ffc1c1;">"\n"</span>)
<span style="color: #00ffff;">print</span>(<span style="color: #ffc1c1;">"The Network Output is:\n---\n"</span>)
<span style="color: #00ffff;">print</span>(model.forward(X_train[7,:]).item(), <span style="color: #ffc1c1;">"\n"</span>)

</pre>
</div>

<pre class="example" id="org4266945">
The Network input is:
---

tensor([-1.5129,  2.9332]) 

The Network Output is:
---

0.22973690927028656 
</pre>
</div>
</div>

<div id="outline-container-org418c87f" class="outline-3">
<h3 id="org418c87f"><span class="section-number-3">3.4</span> Train the Model with Gradient Descent&#xa0;&#xa0;&#xa0;<span class="tag"><span class="7d46636">7d46636</span></span></h3>
<div class="outline-text-3" id="text-3-4">
<p>
Now that the model has been fit, a method to train the model can be
implmented <sup><a id="fnr.8" class="footref" href="#fn.8">8</a></sup>:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">class</span> <span style="color: #63b8ff;">three_layer_classification_network</span>(nn.Module):
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">__init__ method goes here, see above</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">...</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">...</span>

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">train</span>(<span style="color: #00ffff;">self</span>, x, target, &#951;=30, iterations=2e4):
        bar = Bar(<span style="color: #ffc1c1;">'Processing'</span>, <span style="color: #b0c4de;">max</span>=iterations) <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">progress bar</span>
        <span style="color: #00ffff;">for</span> t <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(<span style="color: #b0c4de;">int</span>(iterations)):

            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Calculate y, forward pass</span>
            y_pred = <span style="color: #00ffff;">self</span>.forward(x)

            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Measure the loss</span>
            loss = <span style="color: #00ffff;">self</span>.loss_fn(x, target)

            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">print(loss.item())</span>
            <span style="color: #00ffff;">self</span>.losses.append(loss.item())

            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Calculate the Gradients with Autograd</span>
            loss.backward()

            <span style="color: #00ffff;">with</span> torch.no_grad():
                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Update the Weights with Gradient Descent </span>
                <span style="color: #00ffff;">self</span>.wi -= &#951; * <span style="color: #00ffff;">self</span>.wi.grad; <span style="color: #00ffff;">self</span>.wi.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                <span style="color: #00ffff;">self</span>.bi -= &#951; * <span style="color: #00ffff;">self</span>.bi.grad; <span style="color: #00ffff;">self</span>.bi.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                <span style="color: #00ffff;">self</span>.wo -= &#951; * <span style="color: #00ffff;">self</span>.wo.grad; <span style="color: #00ffff;">self</span>.wo.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                <span style="color: #00ffff;">self</span>.bo -= &#951; * <span style="color: #00ffff;">self</span>.bo.grad; <span style="color: #00ffff;">self</span>.bo.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                <span style="color: #00ffff;">self</span>.&#963;  -= &#951; * <span style="color: #00ffff;">self</span>.&#963;.grad;  <span style="color: #00ffff;">self</span>.&#963;.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
            bar.<span style="color: #b0c4de;">next</span>()
        bar.finish()
                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">; Zero out the gradients, they've been used</span>

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Rest of the Class Definition Below ...VVV...</span>
</pre>
</div>

<p>
With this definition the model can hence be trained in order to
produce meaningful classifications, as shown below, this model classifies the
points perfectly, even on the testing data, the training error 
over time is shown in figure <a href="#org0509bcb">2</a>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Make the Data</span>
<span style="color: #7fffd4;">X_train</span>, <span style="color: #7fffd4;">X_test</span>, <span style="color: #7fffd4;">y_train</span>, <span style="color: #7fffd4;">y_test</span> = make_data(
    n=100, create_plot=<span style="color: #8470ff; font-weight: bold;">True</span>, dtype=dtype, dev=dev)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create a model object</span>
model = three_layer_classification_network(
    input_size=X_train.shape[1], hidden_size=2, output_size=1, dtype=dtype, dev=dev)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Train the Model</span>
model.train(X_train, y_train, &#951;=1e-2, iterations=10000)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Plot the losses</span>
plt.plot(model.losses)
plt.title(<span style="color: #ffc1c1;">"Losses at each training iteration"</span>)
plt.show()

<span style="color: #00ffff;">print</span>(<span style="color: #ffc1c1;">"The testing misclassification rate is:\n"</span>)
<span style="color: #00ffff;">print</span>(model.misclassification_rate(X_test, y_test))
</pre>
</div>



<div id="org0509bcb" class="figure">
<p><img src="./media/loss_function_initial_nn.png" alt="loss_function_initial_nn.png" width="50 px" />
</p>
<p><span class="figure-number">Figure 2: </span>Training error, given by \(l\left( x \right) = \sum^{n}_{i= 1} \left[ \left( x_i - f\left( x_i \right)  \right)^2  \right]\), at each iteration of training</p>
</div>
</div>
</div>

<div id="outline-container-org1a59c54" class="outline-3">
<h3 id="org1a59c54"><span class="section-number-3">3.5</span> Implement Ranknet&#xa0;&#xa0;&#xa0;<span class="tag"><span class="f25f376">f25f376</span>&#xa0;<span class="05df04f">05df04f</span></span></h3>
<div class="outline-text-3" id="text-3-5">
<p>
Now that the model can classify the data, the implementation will
be modified to:
</p>

<ul class="org-ul">
<li>Measure loss using a BCE function which is reported to perform better in the
literature <a class='org-ref-reference' href="#christopherburgesRankNetRankingRetrospective2015">christopherburgesRankNetRankingRetrospective2015</a>,<a class='org-ref-reference' href="#christopherburgesRankNetLambdaRankLambdaMART2010">christopherburgesRankNetLambdaRankLambdaMART2010</a></li>
<li>Modify the model so that it operates pairwise, such that:
<ol class="org-ol">
<li><p>
Two points are identified, sent through the neural network and
two values returned:
</p>
\begin{align}
s_i = n(\mathbf{X}_i) \label{eq:forward_single1}\\
s_j = n(\mathbf{X}_j) \label{eq:forward_single2}
\end{align}
<p>
The network previously created can be adapted for this and
hence the method will be renamed to <code>forward_single</code> and this
will represent function \(n()\) implemented in
\eqref{eq:forward_single1} and \eqref{eq:forward_single2}
</p></li>
<li><p>
These values will be combined to give a single value which is
intended to measure the model confidence:<sup><a id="fnr.9" class="footref" href="#fn.9">9</a></sup>
</p>

\begin{align}
\hat{P}_{ij} &= \mathrm{sig}\left(\sigma, (s_i-s_j)\right), \quad
\exists \sigma \in \mathbb{R} \\
&= \frac{1}{1+e^{\sigma \cdot (s_i-s_j)}} \label{eq:sig-comb}
\end{align}</li>
<li><p>
The range of \eqref{eq:sig-comb}  is the interval \(\hat{P}_{ij} =
        \left[0, 1\right]\), let \(\bar{P}_{ij}\) be the known
probability<sup><a id="fnr.10" class="footref" href="#fn.10">10</a></sup> that \(\mathbf{X}_i \triangleright
        \mathbf{X}_j\), the simulated data has a boolean range of
\(\bar{P}_{ij} \in \left\{0, 1\right\}\), this can be recast
to \(\{-1, 0, 1\}\) and then linearly scaled to \(\left[0,
        1\right]\) like so:
</p>

\begin{align}
\bar{P}_{ij} & \leftarrow p_i - p_j \\
\bar{P}_{ij} & \leftarrow \frac{1+\bar{P}_{ij}}{2}
\end{align}</li>
</ol></li>
</ul>


<p>
These modifications only need to be made to the neural network
class like so:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">class</span> <span style="color: #63b8ff;">three_layer_ranknet_network</span>(nn.Module):
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">__init__ method</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">...</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">...</span>

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">forward</span>(<span style="color: #00ffff;">self</span>, xi, xj):
        <span style="color: #7fffd4;">si</span> = <span style="color: #00ffff;">self</span>.forward_single(xi)
        <span style="color: #7fffd4;">sj</span> = <span style="color: #00ffff;">self</span>.forward_single(xj)
        <span style="color: #7fffd4;">out</span> = 1 / (1 + torch.exp(-<span style="color: #00ffff;">self</span>.&#963; * (si - sj)))  
        <span style="color: #00ffff;">return</span> out

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">forward_single</span>(<span style="color: #00ffff;">self</span>, x):
        <span style="color: #7fffd4;">x</span> = torch.matmul(x, <span style="color: #00ffff;">self</span>.wi).add(<span style="color: #00ffff;">self</span>.bi)
        <span style="color: #7fffd4;">x</span> = torch.sigmoid(x)
        <span style="color: #7fffd4;">x</span> = torch.matmul(x, <span style="color: #00ffff;">self</span>.wo).add(<span style="color: #00ffff;">self</span>.bo)
        <span style="color: #7fffd4;">x</span> = torch.sigmoid(x)

        <span style="color: #00ffff;">return</span> x

    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">loss_fn</span>(<span style="color: #00ffff;">self</span>, xi, xj, y):
        <span style="color: #7fffd4;">y_pred</span> = <span style="color: #00ffff;">self</span>.forward(xi, xj)
        <span style="color: #7fffd4;">loss</span> = torch.mean(-y * torch.log(y_pred) -
                          (1 - y) * torch.log(1 - y_pred))
        <span style="color: #00ffff;">return</span> loss

   <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">pairwise</span>(iterable):
       <span style="color: #f08080; font-style: italic;">"pairwise([1,2,3,4]) --&gt; [(1, 2), (1, 3), (1, 4), (2, 3), (2, 4), (3, 4)]"</span>
       <span style="color: #7fffd4;">s</span> = <span style="color: #b0c4de;">list</span>(iterable)
       <span style="color: #7fffd4;">pair_iter</span> = chain.from_iterable(combinations(s, r) <span style="color: #00ffff;">for</span> r <span style="color: #00ffff;">in</span> [2])
       <span style="color: #00ffff;">return</span> pair_iter

</pre>
</div>

<p>
The training method must be adapted to interact with these changes
like so:<sup><a id="fnr.11" class="footref" href="#fn.11">11</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">class</span> <span style="color: #63b8ff;">three_layer_ranknet_network</span>(nn.Module):
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">__init__ method</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">...</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">...</span>
    <span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">train</span>(<span style="color: #00ffff;">self</span>, x, target, &#951;=1e-2, iterations=4e2):
        <span style="color: #00ffff;">self</span>.trainedQ = <span style="color: #8470ff; font-weight: bold;">True</span>
        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create a progress bar</span>
        bar = Bar(<span style="color: #ffc1c1;">'Processing'</span>, <span style="color: #b0c4de;">max</span>=iterations)
        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Train for a number of iterations</span>
        <span style="color: #00ffff;">for</span> t <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(<span style="color: #b0c4de;">int</span>(iterations)):
            sublosses = []
            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Loop over every pair of values</span>
            <span style="color: #00ffff;">for</span> pair <span style="color: #00ffff;">in</span> pairwise(<span style="color: #b0c4de;">range</span>(<span style="color: #b0c4de;">len</span>(x) - 1)):
                xi, yi = x[pair[0], ], target[pair[0]]
                xj, yj = x[pair[1], ], target[pair[1]]

                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">encode from {0, 1} to {-1, 0, 1}</span>
                y = yi - yj

                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Scale between {0,1}</span>
                y = 1 / 2 * (1 + y)

                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Calculate y, forward pass</span>
                y_pred = <span style="color: #00ffff;">self</span>.forward(xi, xj)

                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Measure the loss</span>
                loss = <span style="color: #00ffff;">self</span>.loss_fn(xi, xj, y)
                sublosses.append(loss.item())

                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Calculate the Gradients with Autograd</span>
                loss.backward()

                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Update the Weights with Gradient Descent</span>
                <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">; Zero out the gradients, they've been used</span>
                <span style="color: #00ffff;">with</span> torch.no_grad():
                    <span style="color: #00ffff;">self</span>.wi -= &#951; * <span style="color: #00ffff;">self</span>.wi.grad; <span style="color: #00ffff;">self</span>.wi.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                    <span style="color: #00ffff;">self</span>.bi -= &#951; * <span style="color: #00ffff;">self</span>.bi.grad; <span style="color: #00ffff;">self</span>.bi.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                    <span style="color: #00ffff;">self</span>.wo -= &#951; * <span style="color: #00ffff;">self</span>.wo.grad; <span style="color: #00ffff;">self</span>.wo.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                    <span style="color: #00ffff;">self</span>.bo -= &#951; * <span style="color: #00ffff;">self</span>.bo.grad; <span style="color: #00ffff;">self</span>.bo.grad = <span style="color: #8470ff; font-weight: bold;">None</span>
                    <span style="color: #00ffff;">self</span>.&#963;  -= &#951; * <span style="color: #00ffff;">self</span>.&#963;.grad ; <span style="color: #00ffff;">self</span>.&#963;.grad  = <span style="color: #8470ff; font-weight: bold;">None</span>

            <span style="color: #00ffff;">self</span>.losses.append(np.average(sublosses))
            bar.<span style="color: #b0c4de;">next</span>()
        bar.finish()
        <span style="color: #00ffff;">self</span>.threshold_train(x, target, plot=<span style="color: #8470ff; font-weight: bold;">False</span>)
</pre>
</div>

<p>
This can then be implemented as before, the loss function is
provided at figure <a href="#org73d22b0">3</a>. 
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Make the Data</span>
<span style="color: #7fffd4;">X_train</span>, <span style="color: #7fffd4;">X_test</span>, <span style="color: #7fffd4;">y_train</span>, <span style="color: #7fffd4;">y_test</span> = make_data(
    n=30, create_plot=<span style="color: #8470ff; font-weight: bold;">True</span>, dtype=dtype, dev=dev)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create a model object</span>
model = three_layer_ranknet_network(
    input_size=X_train.shape[1], hidden_size=2, output_size=1, dtype=dtype, dev=dev)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Train the Model</span>
model.train(X_train, y_train, &#951;=1e-1, iterations=1e2)

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Save the losses</span>
np.savetxt(fname=<span style="color: #ffc1c1;">"/tmp/losses.csv"</span>, X=model.losses, delimiter=<span style="color: #ffc1c1;">','</span>)

</pre>
</div>


<div id="org73d22b0" class="figure">
<p><img src="./media/ranknet_loss.png" alt="ranknet_loss.png" width="400px" />
</p>
<p><span class="figure-number">Figure 3: </span>BCE training loss at each iteration for the Ranknet method.</p>
</div>
</div>
</div>

<div id="outline-container-org746caac" class="outline-3">
<h3 id="org746caac"><span class="section-number-3">3.6</span> Implement sorting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="99b390a">99b390a</span>&#xa0;<span class="7d46636">7d46636</span></span></h3>
<div class="outline-text-3" id="text-3-6">
<p>
One of the difficulties in implementing this, however, is that it
is not simple to determine whether or not the model has classified
the data well,<sup><a id="fnr.12" class="footref" href="#fn.12">12</a></sup> In order to address this the model can be
implemented to sort the data by ranked values and then
visualised. To implement this a derivative of the <i>quicksort</i>
algorithm was chosen as a sorting function
<a class='org-ref-reference' href="#hoareAlgorithm64Quicksort1961">hoareAlgorithm64Quicksort1961</a>, this was implemented by
adapting code already available in the literature
<a class='org-ref-reference' href="#kernighanProgrammingLanguage1988">kernighanProgrammingLanguage1988</a> and online
<a class='org-ref-reference' href="#PythonProgramQuickSort2014">PythonProgramQuickSort2014</a>:  
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">split</span>(values, left, right, data, model):
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Define the leftmost value</span>
    <span style="color: #7fffd4;">l</span> = (left-1)
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Set the right value as the pivot</span>
    <span style="color: #7fffd4;">pivot</span> = values[right]  <span style="color: #fa8072;"># </span><span style="color: #cc9393;">TODO</span><span style="color: #ff7f24; font-style: italic;"> The pivot should be random</span>

    <span style="color: #00ffff;">for</span> q <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(left, right):
        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Only move smaller values left</span>
        <span style="color: #00ffff;">if</span> leq(values[q], pivot, data, model):
            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">+1 next left element</span>
            <span style="color: #7fffd4;">l</span> = l+1
            <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Swap the current element onto the left</span>
            <span style="color: #7fffd4;">values</span>[<span style="color: #7fffd4;">l</span>], <span style="color: #7fffd4;">values</span>[<span style="color: #7fffd4;">q</span>] = values[q], values[l]

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Swap the pivot value into the left position from the right</span>
    <span style="color: #7fffd4;">values</span>[<span style="color: #7fffd4;">l</span>+1], <span style="color: #7fffd4;">values</span>[<span style="color: #7fffd4;">right</span>] = values[right], values[l+1]
    <span style="color: #00ffff;">return</span> (l+1)


<span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">qsort</span>(values, left, right, data, model):
    <span style="color: #00ffff;">if</span> <span style="color: #b0c4de;">len</span>(values) == 1:
        <span style="color: #00ffff;">return</span> values
    <span style="color: #00ffff;">if</span> right &gt; <span style="color: #7fffd4;">left</span>:
        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">pi is the index of where the pivot was moved to</span>
        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">It's position is now correct</span>
        pi = split(values, left, right, data, model)

        <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Do this again for the left and right parts</span>
        qsort(values, left, pi-1, data, model)
        qsort(values, pi+1, right, data, model)

<span style="color: #00ffff;">import</span> random

<span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">leq</span>(a, b, data, model):
    <span style="color: #7fffd4;">score</span> = model.forward(data[a, :], data[b, :])
    <span style="color: #00ffff;">if</span> score &lt;= 0.5:
        <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">True</span>
    <span style="color: #00ffff;">if</span> score &gt; 0.5:
        <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">False</span>

        <span style="color: #00ffff;">if</span> (a &lt; b):
            <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">True</span>
        <span style="color: #00ffff;">else</span>:
            <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">False</span>


<span style="color: #00ffff;">if</span> DEBUG:
    <span style="color: #00ffff;">for</span> i <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(3):
        <span style="color: #00ffff;">import</span> random
        values = random.sample(<span style="color: #b0c4de;">range</span>(9), 7)
        <span style="color: #7fffd4;">n</span> = <span style="color: #b0c4de;">len</span>(values)
        <span style="color: #00ffff;">print</span>(values)
        qsort(values, 0, n-1, data, model)
        <span style="color: #00ffff;">print</span>(<span style="color: #ffc1c1;">"==&gt;"</span>, values)

</pre>
</div>

<p>
The data can then be plotted, as in figure and exported like so:<sup><a id="fnr.13" class="footref" href="#fn.13">13</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Main Function</span>
<span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">main</span>():
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Make the Data</span>
    <span style="color: #7fffd4;">X_train</span>, <span style="color: #7fffd4;">X_test</span>, <span style="color: #7fffd4;">y_train</span>, <span style="color: #7fffd4;">y_test</span> = make_data(n=100,
                                                 create_plot=<span style="color: #8470ff; font-weight: bold;">True</span>,
                                                 dtype=dtype,
                                                 dev=dev)

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create a model object</span>
    model = three_layer_ranknet_network(input_size=X_train.shape[1],
                                        hidden_size=2,
                                        output_size=1,
                                        dtype=dtype,
                                        dev=dev)

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Train the Model</span>
    model.train(X_train, y_train, &#951;=1e-1, iterations=1e2)

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Visualise the Training Error</span>
    plot_losses(model)

    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Misclassification won't work for ranked data</span>
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Instead Visualise the ranking</span>
    plot_ranked_data(X_test, y_test, model)


<span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">plot_losses</span>(model):
    plt.plot(model.losses)
    plt.title(<span style="color: #ffc1c1;">"Cost / Loss Function for Iteration of Training"</span>)
    plt.show()


<span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">plot_ranked_data</span>(X, y, model):
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Create a list of values</span>
    n = X.shape[0]
    order = [i <span style="color: #00ffff;">for</span> i <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(n)]
    <span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Arrange that list of values based on the model</span>
    quicksort(values=order, left=0, right=(n - 1), data=X, model=model)
    <span style="color: #00ffff;">print</span>(order)

    ordered_data = X[order, :]
    y_ordered = y[order]

    np.savetxt(<span style="color: #ffc1c1;">"/tmp/ordered_data.csv"</span>, X=ordered_data.numpy(), delimiter=<span style="color: #ffc1c1;">','</span>)

    p = plt.figure()
    <span style="color: #00ffff;">for</span> i <span style="color: #00ffff;">in</span> <span style="color: #b0c4de;">range</span>(<span style="color: #b0c4de;">len</span>(ordered_data)):
        plt.text(ordered_data[i, 0], ordered_data[i, 1], i)
    plt.scatter(ordered_data[:, 0], ordered_data[:, 1], c=y_ordered)
    plt.title(<span style="color: #ffc1c1;">"Testing Data, with ranks"</span>)
    plt.show()


<span style="color: #00ffff;">if</span> <span style="color: #b0c4de;">__name__</span> == <span style="color: #ffc1c1;">"__main__"</span>:
    main()
</pre>
</div>



<div id="org3b879e8" class="figure">
<p><img src="media/ordered_blobs.png" alt="ordered_blobs.png" width="400px" />
</p>
<p><span class="figure-number">Figure 4: </span>Using Machine Learned Ranking to order the points from most to least relevant</p>
</div>

<p>
So instead of ranking, sort the values, this produces the output.
</p>

<p>
but this is the problem, did it work? it's not clear, because even
if the model was not trained we get the following (put them side by side).
</p>

<p>
So this is definitely one of the hard issues.
</p>

<p>
what would be better would be to classify data with a rating
(i.e. wine scores), only show the model whether the wine is
good/bad and compare the output order with the input order, that
would be an effective way to see that it works. This was not yet
effectively implemented.
</p>
</div>
</div>
<div id="outline-container-orgd4409c0" class="outline-3">
<h3 id="orgd4409c0"><span class="section-number-3">3.7</span> Moons</h3>
</div>
<div id="outline-container-orga808003" class="outline-3">
<h3 id="orga808003"><span class="section-number-3">3.8</span> Optimisers</h3>
</div>
<div id="outline-container-org865c3e2" class="outline-3">
<h3 id="org865c3e2"><span class="section-number-3">3.9</span> Batches</h3>
</div>
<div id="outline-container-orgbe7cf0a" class="outline-3">
<h3 id="orgbe7cf0a"><span class="section-number-3">3.10</span> Wine</h3>
</div>
<div id="outline-container-org64cf152" class="outline-3">
<h3 id="org64cf152"><span class="section-number-3">3.11</span> Rank Wiki Articles</h3>
</div>
</div>
<div id="outline-container-orgfcfd80e" class="outline-2">
<h2 id="orgfcfd80e"><span class="section-number-2">4</span> Difficulties</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Don't use torch
<ul class="org-ul">
<li>Do it by hand first because it can be hard to see if the correct
weights are being updated sensibly, making debugging very difficult.</li>
<li>R or Julia would be easier because counting from 0 get's pretty
confusing when dealing with {1, 0}, {-1, 0, 1}.</li>
</ul></li>
<li><p>
Don't use misclassification rate to measure whether the ranking
</p>
<ul class="org-ul">
<li>In hindsight this is obvious, but at the time misclassification
was a tempting metric because of it's interpretability</li>
</ul>
<p>
was correct
</p>

<p>
Very difficult to see if the model is working
</p></li>

<li>A continuous function will still produce an ordered pattern in
the ranking of results, even if the model hasn't been trained,
so visualising isn't helpful either.</li>

<li>Implement it on a data set that already has order, obfuscate the
order and then contrast the results
<ul class="org-ul">
<li>or use a measurement</li>
</ul></li>

<li>Plot the loss function of the training data live, the model is
slow to train and waiting for it to develop was a massive time
drain.</li>
</ul>
</div>
</div>



<div id="outline-container-org0b49592" class="outline-2">
<h2 id="org0b49592"><span class="section-number-2">5</span> Further Research</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgb8813f5" class="outline-3">
<h3 id="orgb8813f5"><span class="section-number-3">5.1</span> Practical Improvements</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Apply this to documents to get a sorted list, like the wine data</li>
<li>The "Quicksort" algorithm likely needs a random pivot to be efficient <a class='org-ref-reference' href="#timroughgardenQuicksortOverview2017">timroughgardenQuicksortOverview2017</a></li>
</ul>
</div>
</div>

<div id="outline-container-org459e246" class="outline-3">
<h3 id="org459e246"><span class="section-number-3">5.2</span> Evaluate performance improvements</h3>
<div class="outline-text-3" id="text-5-2">
<p>
It is still not clear how the
performance of Ranknet compares to traditional approaches
implemented by search engines (see &sect; <a href="#search-engines-list">9.1</a>), further
study would ideally:
</p>

<ul class="org-ul">
<li>Write a program to query a corpus of documents using an existing search engine.
<ul class="org-ul">
<li>Or possibly just implement TF-IDF weighting in order to remove variables.</li>
</ul></li>
<li>Extend the program to implement machine learned ranking</li>
<li>Measure and contrast the performance of the two models to see
whether there are any significant improvements.</li>
</ul>

<p>
This could be implemented with TREC datasets
<a class='org-ref-reference' href="#usnationalinstituteofstandardsandtechnologyTextREtrievalConference">usnationalinstituteofstandardsandtechnologyTextREtrievalConference</a>
using a cummulated-gain cost function
<a class='org-ref-reference' href="#jarvelinCumulatedGainbasedEvaluation2002">jarvelinCumulatedGainbasedEvaluation2002</a> as demonstrated in
previous work <a class='org-ref-reference' href="#viksinghComparisonOpenSource2009">viksinghComparisonOpenSource2009</a>.
</p>
</div>
</div>

<div id="outline-container-machine-learning-models" class="outline-3">
<h3 id="machine-learning-models"><span class="section-number-3">5.3</span> Evaluate alternative machine learning models</h3>
<div class="outline-text-3" id="text-machine-learning-models">
<p>
i.e. can SVM's or trees be used instead of neural networks?
</p>
</div>
</div>
</div>

<div id="outline-container-org3282a97" class="outline-2">
<h2 id="org3282a97"><span class="section-number-2">6</span> Conclusion</h2>
</div>

<div id="outline-container-org8f982a8" class="outline-2">
<h2 id="org8f982a8"><span class="section-number-2">7</span> Text and References</h2>
<div class="outline-text-2" id="text-7">
<p>
Fractals are complex shapes that often occur from natural processes, in this
report we hope to investigate the emergence of patterns and complex structures
from natural phenomena. We begin with an investigation into fractals and the
concept of dimension and then discuss links between fractal patterns and natural
processes.
</p>

<p>
This is a Reference <a class='org-ref-reference' href="#tuGraphBasedSemiSupervisedNearestNeighbor2016a">tuGraphBasedSemiSupervisedNearestNeighbor2016a</a> and another <a class='org-ref-reference' href="#nicodemiIntroductionAbstractAlgebra2007a">nicodemiIntroductionAbstractAlgebra2007a</a> and yet another <a class='org-ref-reference' href="#christopherburgesRankNetLambdaRankLambdaMART2010">christopherburgesRankNetLambdaRankLambdaMART2010</a>.
</p>
</div>
</div>

<div id="outline-container-org89639a6" class="outline-2">
<h2 id="org89639a6"><span class="section-number-2">8</span> Fractals</h2>
<div class="outline-text-2" id="text-8">
<p>
Images are shown in figure .
</p>

<p>

</p>
</div>
</div>

<div id="outline-container-org90e20f4" class="outline-2">
<h2 id="org90e20f4"><span class="section-number-2">9</span> Appendix</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-search-engines-list" class="outline-3">
<h3 id="search-engines-list"><span class="section-number-3">9.1</span> Search Engines</h3>
<div class="outline-text-3" id="text-search-engines-list">
<p>
There are many open source search engines available , a cursory review
found the following popular projects:
</p>

<ul class="org-ul">
<li><a href="https://github.com/cyclaero/zettair">Zettair</a> (<code>C</code>) <a class='org-ref-reference' href="#jansenCyclaeroZettair2020">jansenCyclaeroZettair2020</a></li>
<li><a href="https://github.com/apache/lucene-solr">Apache lucene/Solr</a> (<code>Java</code>) <a class='org-ref-reference' href="#apachesoftwarefoundationLearningRankApache2017">apachesoftwarefoundationLearningRankApache2017</a>
<ul class="org-ul">
<li>Implemented by <a href="https://sourceforge.net/p/docfetcher/code/ci/master/tree/">DocFetcher</a> <a class='org-ref-reference' href="#docfetcherdevelopmentteamDocFetcherFastDocument">docfetcherdevelopmentteamDocFetcherFastDocument</a></li>
</ul></li>
<li><a href="https://github.com/sphinxsearch/sphinx">Sphinx</a> (<code>C++</code>) <a class='org-ref-reference' href="#yurischapovSphinxsearchSphinx2021">yurischapovSphinxsearchSphinx2021</a></li>
<li><a href="https://github.com/kevinduraj/xapian-search">Xapian</a> (<code>C++</code>) <a class='org-ref-reference' href="#ollybettsXapianXapian2021">ollybettsXapianXapian2021</a>
<ul class="org-ul">
<li>Implemented by <a href="https://www.lesbonscomptes.com/recoll/">Recoll</a> <a class='org-ref-reference' href="#jean-francoisdockesRecollUserManual">jean-francoisdockesRecollUserManual</a></li>
</ul></li>
</ul>

<p>
More Modern Search engines include:
</p>

<ul class="org-ul">
<li><a href="https://github.com/olivernn/lunr.js/">LunrJS</a>  (<code>JS</code>) <a class='org-ref-reference' href="#nightingaleOlivernnLunrJs2021">nightingaleOlivernnLunrJs2021</a></li>
<li><a href="https://github.com/blevesearch/bleve">Bleve Search</a> (<code>Go</code>) <a class='org-ref-reference' href="#martyschochBleveSearchDocumentation">martyschochBleveSearchDocumentation</a></li>
<li><a href="https://github.com/go-ego/riot">Riot</a> (<code>Go</code>) <a class='org-ref-reference' href="#vzGoegoRiot2021">vzGoegoRiot2021</a></li>
<li><a href="https://github.com/tantivy-search/tantivy">Tantivy</a> (<code>Rust</code>) <a class='org-ref-reference' href="#clementrenaultMeilisearchMeiliSearch2021">clementrenaultMeilisearchMeiliSearch2021</a></li>
<li><a href="https://github.com/andylokandy/simsearch-rs">SimSearch</a> (<code>Rust</code>) <a class='org-ref-reference' href="#lokAndylokandySimsearchrs2021">lokAndylokandySimsearchrs2021</a></li>
</ul>
</div>


<div id="outline-container-orgbe05cd2" class="outline-4">
<h4 id="orgbe05cd2"><span class="section-number-4">9.1.1</span> Fuzzy String Match</h4>
<div class="outline-text-4" id="text-9-1-1">
<p>
Somewhat related are programs that rank string similarity, such programs don't tend
to perform well on documents however (so for example these would
be effective to filter document titles but would not be useful for
querying documents):
</p>

<ul class="org-ul">
<li><a href="https://github.com/junegunn/fzf"><code>fzf</code></a> <a class='org-ref-reference' href="#choiJunegunnFzf2021">choiJunegunnFzf2021</a></li>
<li><a href="https://github.com/jhawthorn/fzy"><code>fzy</code></a> <a class='org-ref-reference' href="#hawthornJhawthornFzy2021">hawthornJhawthornFzy2021</a></li>
<li><a href="https://github.com/peco/peco"><code>peco</code></a> <a class='org-ref-reference' href="#lestrratPecoPeco2021">lestrratPecoPeco2021</a></li>
<li><a href="https://github.com/lotabout/skim">Skim</a> <a class='org-ref-reference' href="#zhangLotaboutSkim2021">zhangLotaboutSkim2021</a></li>
<li><a href="https://github.com/lotabout/skim"><code>go-fuzzyfinder</code></a> <a class='org-ref-reference' href="#ktrKtr0731Gofuzzyfinder2021">ktrKtr0731Gofuzzyfinder2021</a></li>
<li><a href="https://github.com/lotabout/skim">Swiper</a> <a class='org-ref-reference' href="#krehelAboaboSwiper2021">krehelAboaboSwiper2021</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-standard-import" class="outline-3">
<h3 id="standard-import"><span class="section-number-3">9.2</span> Import Statements</h3>
<div class="outline-text-3" id="text-standard-import">
<p>
The following import statements were included, where used, <sup><a id="fnr.14" class="footref" href="#fn.14">14</a></sup>
separate scripts were used to make the model as modular as possible,
such corresponding inputs have also been listed:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Import Packages</span>
<span style="color: #00ffff;">from</span> itertools <span style="color: #00ffff;">import</span> chain
<span style="color: #00ffff;">from</span> itertools <span style="color: #00ffff;">import</span> combinations
<span style="color: #00ffff;">from</span> itertools <span style="color: #00ffff;">import</span> tee
<span style="color: #00ffff;">from</span> progress.bar <span style="color: #00ffff;">import</span> Bar
<span style="color: #00ffff;">import</span> math <span style="color: #00ffff;">as</span> m
<span style="color: #00ffff;">import</span> matplotlib.pyplot <span style="color: #00ffff;">as</span> plt
<span style="color: #00ffff;">import</span> numpy <span style="color: #00ffff;">as</span> np
<span style="color: #00ffff;">import</span> random
<span style="color: #00ffff;">import</span> sys
<span style="color: #00ffff;">import</span> sys
<span style="color: #00ffff;">import</span> torch
<span style="color: #00ffff;">import</span> torch
<span style="color: #00ffff;">from</span> torch <span style="color: #00ffff;">import</span> nn

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Sepereate Scripts lcated below main</span>
<span style="color: #00ffff;">from</span> ranknet.test_cuda <span style="color: #00ffff;">import</span> test_cuda
<span style="color: #00ffff;">from</span> ranknet.make_data <span style="color: #00ffff;">import</span> make_data
<span style="color: #00ffff;">from</span> ranknet.neural_network <span style="color: #00ffff;">import</span> three_layer_ranknet_network
<span style="color: #00ffff;">from</span> ranknet.quicksort <span style="color: #00ffff;">import</span> quicksort
</pre>
</div>
</div>
</div>

<div id="outline-container-export-data-function" class="outline-3">
<h3 id="export-data-function"><span class="section-number-3">9.3</span> Export Data Method</h3>
<div class="outline-text-3" id="text-export-data-function">
<p>
The data was exported by printing the values to a text file like
so:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">def</span> <span style="color: #00fa9a; font-weight: bold;">export_data</span>(X, y, export):
    <span style="color: #00ffff;">try</span>:
        os.remove(export)
        <span style="color: #00ffff;">print</span>(<span style="color: #ffc1c1;">"Warning, given file was over-written"</span>)
    <span style="color: #00ffff;">except</span>:
        <span style="color: #00ffff;">pass</span>

    <span style="color: #00ffff;">with</span> <span style="color: #b0c4de;">open</span>(export, <span style="color: #ffc1c1;">"a"</span>) <span style="color: #00ffff;">as</span> f:
        line = <span style="color: #ffc1c1;">"x1, x2, y \n"</span>
        f.write(line)
        <span style="color: #00ffff;">for</span> i <span style="color: #00ffff;">in</span> (<span style="color: #b0c4de;">range</span>(X.shape[0])):
            <span style="color: #7fffd4;">line</span> = <span style="color: #b0c4de;">str</span>(X[i][0]) + <span style="color: #ffc1c1;">", "</span> + <span style="color: #b0c4de;">str</span>(X[i][1]) + <span style="color: #ffc1c1;">", "</span> + <span style="color: #b0c4de;">str</span>(y[i]) + <span style="color: #ffc1c1;">"\n"</span>
            f.write(line)
    <span style="color: #00ffff;">print</span>(<span style="color: #ffc1c1;">"Data Exported"</span>)


</pre>
</div>
</div>
</div>

<div id="outline-container-version-control-repo" class="outline-3">
<h3 id="version-control-repo"><span class="section-number-3">9.4</span> Version Control Repository</h3>
<div class="outline-text-3" id="text-version-control-repo">
<p>
The <code>git</code> repository used in production of this code is currently
available on <i>GitHub</i> at <a href="https://github.com/CRMDS/CRMDS-HDR-Training-2020">github.com/CRMDS/CRMDS-HDR-Training-2020</a>, in
order to get a local copy, execute the following commands (<code>bash</code>): 
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Clone the repository</span>
git clone https://github.com/CRMDS/CRMDS-HDR-Training-2020

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Change to the subdirectory</span>
<span style="color: #b0c4de;">cd</span> CRMDS-HDR-Training-2020/ranknet

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">Checkout the Walkthrough branch</span>
git checkout walkkthrough

<span style="color: #fa8072;"># </span><span style="color: #ff7f24; font-style: italic;">list the changes</span>
git log
</pre>
</div>

<p>
Consider the use of tools like <a href="https://magit.vc/">magit</a> <a class='org-ref-reference' href="#MagitMagit2008">MagitMagit2008</a> and
<a href="https://github.com/emacsmirror/git-timemachine">git-timemachine</a> <a class='org-ref-reference' href="#peterstiernstromEmacsmirrorGittimemachine2014">peterstiernstromEmacsmirrorGittimemachine2014</a> (or
<a href="https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens">GitLens</a> <a class='org-ref-reference' href="#amodioEamodioVscodegitlens2016">amodioEamodioVscodegitlens2016</a> and <a href="https://marketplace.visualstudio.com/items?itemName=bee.git-temporal-vscode">git-temporal</a>
<a class='org-ref-reference' href="#beewilkersonGittemporalGittemporalMono2018">beewilkersonGittemporalGittemporalMono2018</a> in VsCode) in order
to effectively preview the changes at each step, alternatively a
pager like <a href="https://github.com/sharkdp/bat">bat</a> <a class='org-ref-reference' href="#peterSharkdpBat2018">peterSharkdpBat2018</a> can also be used with something like <a href="https://github.com/junegunn/fzf">fzf</a>
<a class='org-ref-reference' href="#choiJunegunnFzf2021">choiJunegunnFzf2021</a> like so:
</p>

<div class="org-src-container">
<pre class="src src-bash">git log | grep <span style="color: #ffc1c1;">'^commit'</span> | sed <span style="color: #ffc1c1;">'s/^commit\ //'</span> |<span style="color: #ffc1c1;">\</span>
    fzf --preview <span style="color: #ffc1c1;">'git diff {}^! |\</span>
<span style="color: #ffc1c1;">     bat --color always'</span>  
</pre>
</div>
</div>

<div id="outline-container-git-log" class="outline-4">
<h4 id="git-log"><span class="section-number-4">9.4.1</span> Version Control Log for Walkthrough</h4>
<div class="outline-text-4" id="text-git-log">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><b><i>Commit ID</i></b></th>
<th scope="col" class="org-left"><b><i>Message</i></b></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>ed5f4cf</code></td>
<td class="org-left"><i>Initial Commit</i></td>
</tr>

<tr>
<td class="org-left"><code>075acf9</code></td>
<td class="org-left"><i>Walkthrough Initial Commit</i></td>
</tr>

<tr>
<td class="org-left"><code>cf9ab26</code></td>
<td class="org-left"><i>Generate data to use for classification</i></td>
</tr>

<tr>
<td class="org-left"><code>7291112</code></td>
<td class="org-left"><i>Create a Neural Network Model</i></td>
</tr>

<tr>
<td class="org-left"><code>7d46636</code></td>
<td class="org-left"><i>Implement gradient descent to train neural network</i></td>
</tr>

<tr>
<td class="org-left"><code>f25f376</code></td>
<td class="org-left"><i>Adapt Neural Network to perform Ranking</i></td>
</tr>

<tr>
<td class="org-left"><code>42509ab</code></td>
<td class="org-left"><i>Implement sorting algorithm to visualise ranking order</i></td>
</tr>

<tr>
<td class="org-left"><code>05df04f</code></td>
<td class="org-left"><i>Adapt Neural Network to perform Ranking</i></td>
</tr>

<tr>
<td class="org-left"><code>99b390a</code></td>
<td class="org-left"><i>Implement sorting algorithm to visualise ranking order</i></td>
</tr>

<tr>
<td class="org-left"><code>473dce3</code></td>
<td class="org-left"><i>Implement optimizer to replace mere gradient descent</i></td>
</tr>

<tr>
<td class="org-left"><code>4141e92</code></td>
<td class="org-left"><i>Train Model using Batches not entire dataset</i></td>
</tr>

<tr>
<td class="org-left"><code>a2671a6</code></td>
<td class="org-left"><i>Format code to make it more readable</i></td>
</tr>

<tr>
<td class="org-left"><code>d11e607</code></td>
<td class="org-left"><i>plot and only train on different ranked pairs</i></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
An early goal of this research was to evaluate the performance
of different machine learning algorithms to implement the Ranknet
method, as well as contrasting this with simple classification
approaches, this research however is still ongoing,  see &sect;
<a href="#machine-learning-models">5.3</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
<b>RMSE</b> <i>Root Mean Square Error</i>  
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
<b>BCE</b> <i>Binary Cross Entropy</i> 
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
<a href="https://crmds.github.io/CRMDS-HDR-Training-2020/">crmds.github.io/CRMDS-HDR-Training-2020/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
See &sect; <a href="#export-data-function">9.3</a> for the specific method definition used to
export the data to a <code>csv.</code>  
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
Visualisations for this Report were implemented using
<code>org-babel</code> <a class='org-ref-reference' href="#dominikOrgModeReference2018">dominikOrgModeReference2018</a> inside <i>Emacs</i>
<a class='org-ref-reference' href="#stallmanGNUEmacsManual2002">stallmanGNUEmacsManual2002</a> to call <b><i>R</i></b>
<a class='org-ref-reference' href="#rcoreteamLanguageEnvironmentStatistical2021">rcoreteamLanguageEnvironmentStatistical2021</a> with <i>GGPlot2</i>
<a class='org-ref-reference' href="#wickhamGgplot2ElegantGraphics2016a">wickhamGgplot2ElegantGraphics2016a</a> (and <i>Tidyverse</i>
<a class='org-ref-reference' href="#wickhamWelcomeTidyverse2019">wickhamWelcomeTidyverse2019</a> generally), the source code for this
is avaliable in the report manuscript available in the <code>git</code> repository
available at <a href="https://github.com/RyanGreenup/ranknet/blob/main/Report/Report.org">github.com/RyanGreenup/ranknet/blob/main/Report/Report.org</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><p class="footpara">
note that the model has not yet been trained, the weights are
random and the model output is not related to the data at all.
</p></div></div>

<div class="footdef"><sup><a id="fn.8" class="footnum" href="#fnr.8">8</a></sup> <div class="footpara"><p class="footpara">
This class definition is incomplete and serves only to show the
method definition corresponding to the original class shown in &sect;
<a href="#creating-neural-network">3.3</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.9" class="footnum" href="#fnr.9">9</a></sup> <div class="footpara"><p class="footpara">
This value is a measurement of the models "confidence" but
could be extended to represent the "measured probability" of one item
being ranked higher than an other (e.g. the probability that a person
would rank one type of wine as better than the other in a random
sample).
</p></div></div>

<div class="footdef"><sup><a id="fn.10" class="footnum" href="#fnr.10">10</a></sup> <div class="footpara"><p class="footpara">
Note the convention that the symbols \(\triangleleft, \enspace \triangleright\) have been adopted to denote the ranking of two observations,
analogous to \(<, \enspace >\)
</p></div></div>

<div class="footdef"><sup><a id="fn.11" class="footnum" href="#fnr.11">11</a></sup> <div class="footpara"><p class="footpara">
Note the definition of the <code>pairwise</code> function, this was
incorrectly implemented initially (<code>f25f376</code>) and rectified shortly
after (<code>05df04f</code>). see <a href="#git-log">9.4.1</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.12" class="footnum" href="#fnr.12">12</a></sup> <div class="footpara"><p class="footpara">
A naive misclassification method was implemented (<code>f25f376</code>),
but it was not very insightful and so was omitted from this report.
</p></div></div>

<div class="footdef"><sup><a id="fn.13" class="footnum" href="#fnr.13">13</a></sup> <div class="footpara"><p class="footpara">
In this case the plot has been generated by <i>GGPlot2</i> <sup><a id="fnr.6.100" class="footref" href="#fn.6">6</a></sup> 
</p></div></div>

<div class="footdef"><sup><a id="fn.14" class="footnum" href="#fnr.14">14</a></sup> <div class="footpara"><p class="footpara">
Including <code>import</code> statements where they are not used is fine,
other than complaints from a <i>linter</i> following <i>PEP</i>
<a class='org-ref-reference' href="#nickcoghlanPEPStyleGuide2001">nickcoghlanPEPStyleGuide2001</a> (e.g. <a href="https://pypi.org/project/autopep8/">autopep</a>
<a class='org-ref-reference' href="#hattoriAutopep8ToolThat">hattoriAutopep8ToolThat</a>) the code will function just fine.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Ryan Greenup</p>
<p class="date">Created: 2021-02-21 Sun 14:32</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
